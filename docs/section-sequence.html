<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 7 Simulation sequence | mrgsolve User Guide</title>
<meta name="author" content="Metrum Research Group">
<meta name="description" content="This section is intended to help the user understand the steps mrgsolve takes when working through a simulation problem. The focus is on the order in which mrgsolve calls different user-defined...">
<meta name="generator" content="bookdown 0.31 with bs4_book()">
<meta property="og:title" content="Chapter 7 Simulation sequence | mrgsolve User Guide">
<meta property="og:type" content="book">
<meta property="og:url" content="https://mrgsolve.github.io/user_guide/section-sequence.html">
<meta property="og:description" content="This section is intended to help the user understand the steps mrgsolve takes when working through a simulation problem. The focus is on the order in which mrgsolve calls different user-defined...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 7 Simulation sequence | mrgsolve User Guide">
<meta name="twitter:site" content="@mrgsolve">
<meta name="twitter:description" content="This section is intended to help the user understand the steps mrgsolve takes when working through a simulation problem. The focus is on the order in which mrgsolve calls different user-defined...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="bookstyle.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">mrgsolve User Guide</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="model-components.html"><span class="header-section-number">1</span> Model components</a></li>
<li><a class="" href="model-specification.html"><span class="header-section-number">2</span> Model specification</a></li>
<li><a class="" href="data-set-chapter.html"><span class="header-section-number">3</span> Input data sets</a></li>
<li><a class="" href="event-chapter.html"><span class="header-section-number">4</span> Event objects</a></li>
<li><a class="" href="matrix-chapter.html"><span class="header-section-number">5</span> Model Matrices</a></li>
<li><a class="" href="simulated-output.html"><span class="header-section-number">6</span> Simulated output</a></li>
<li><a class="active" href="section-sequence.html"><span class="header-section-number">7</span> Simulation sequence</a></li>
<li><a class="" href="steady-state.html"><span class="header-section-number">8</span> Steady state</a></li>
<li><a class="" href="plugins.html"><span class="header-section-number">9</span> Plugins</a></li>
<li><a class="" href="mtime.html"><span class="header-section-number">10</span> Modeled events</a></li>
<li><a class="" href="topics.html"><span class="header-section-number">11</span> Topics</a></li>
<li><a class="" href="q-and-a.html"><span class="header-section-number">12</span> Questions and Answers</a></li>
<li><a class="" href="install.html"><span class="header-section-number">13</span> Installation</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="section-sequence" class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> Simulation sequence<a class="anchor" aria-label="anchor" href="#section-sequence"><i class="fas fa-link"></i></a>
</h1>
<p>This section is intended to help the user understand
the steps <code>mrgsolve</code> takes when working through
a simulation problem. The focus is on the order
in which <code>mrgsolve</code> calls different user-defined
functions as well as when parameter updates
and output writing happens during the simulation
sequence.</p>
<div id="functions-to-call" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Functions to call<a class="anchor" aria-label="anchor" href="#functions-to-call"><i class="fas fa-link"></i></a>
</h2>
<p>The model specification results in the definition
of four functions that <code>mrgsolve</code> calls during the
simulation sequence. Naming them by
their code block identifiers, the functions are</p>
<ol style="list-style-type: decimal">
<li><code>$PREAMBLE</code></li>
<li><code>$MAIN</code></li>
<li><code>$ODE</code></li>
<li><code>$TABLE</code></li>
</ol>
</div>
<div id="problem-initiation" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Problem initiation<a class="anchor" aria-label="anchor" href="#problem-initiation"><i class="fas fa-link"></i></a>
</h2>
<p>Just prior to starting the problem (when <code>NEWIND</code> is
equal to <code>0</code>), <code>mrgsolve</code> calls <code>$PREAMBLE</code>. This function is only called
once during the simulation sequence. The goal of <code>$PREAMBLE</code> is to allow
the user to work with different <code>C++</code> data structures to get them ready for
the simulation run.</p>
</div>
<div id="subject-initiation" class="section level2" number="7.3">
<h2>
<span class="header-section-number">7.3</span> Subject initiation<a class="anchor" aria-label="anchor" href="#subject-initiation"><i class="fas fa-link"></i></a>
</h2>
<p>After the <code>$PREAMBLE</code> call, <code>mrgsolve</code> simulates
each <code>ID</code> in the data set, one after another. <code>mrgsolve</code> runs this sequence
just prior to simulating a given <code>ID</code></p>
<ol style="list-style-type: decimal">
<li>Copy any parameters that are found in the <code>idata_set</code> to the working
parameter list</li>
<li>Copy any parameters that are found in
the <code>data_set</code> to the working parameter list,
with the copy being taken from the first actual
data set row for that individual. If the
first actual data set record in the data set
is not the first record for the individual,
<code>mrgsolve</code> still copies from the first data
set record as long as the <code>fillbak</code> argument
to <code>mrgsim</code> is <code>TRUE</code>.</li>
<li>Set initial estimates from the base
initial estimate list</li>
<li>Copy initial estimates from <code>idata_set</code> if they
are found there.</li>
<li>Call <code>$MAIN</code>
</li>
<li>Start simulating the records for that individual</li>
</ol>
</div>
<div id="sequence-for-a-single-record" class="section level2" number="7.4">
<h2>
<span class="header-section-number">7.4</span> Sequence for a single record<a class="anchor" aria-label="anchor" href="#sequence-for-a-single-record"><i class="fas fa-link"></i></a>
</h2>
<p><code>mrgsolve</code> executes this sequence while working
from record to record for a given <code>ID</code></p>
<ol style="list-style-type: decimal">
<li>If <code>nocb</code> (next observation carried backward) is <code>TRUE</code>, then parameters
are copied from the current record if that is an actual data set record.
Note that if <code>nocb</code> is <code>FALSE</code> then <code>locf</code> (first observation carried forward)
is assumed to be <code>TRUE</code> (see below). This is the last parameters will be
copied from any input data set prior to advancing the system (when <code>locf</code>
is being used). Therefore, when parameter columns are found in both
an <code>idata_set</code> and a <code>data_set</code>, it will be the value found in the <code>data_set</code>
that will overwrite both the base list and any parameter value that was
copied from an <code>idata_set</code>. It is not an error to have different parameter
values in an <code>idata_set</code> and a <code>data-set</code>, but the value found in the <code>data_set</code>
will be used when this happens. More on parameters and the parameter update
sequence can be found in sections <a href="topics.html#topic-parameter-update">11.3</a> and
<a href="model-components.html#component-param">1.1</a>.</li>
<li>
<code>$MAIN</code> is called</li>
<li>The system is advanced via <code>$ODE</code> or <code>$PKMODEL</code>,
whichever one is invoked in the model specification
file.</li>
<li>If the current record is a dosing record,
the dose is implemented (e.g. bolus made or
infusion started).</li>
<li>If the system is advancing according to
<code>locf</code>, then parameters are copied from
the current record if that is an actual data set
record. This is in contrast to <code>nocb</code> advance (see
above).</li>
<li>The <code>$TABLE</code> function is called</li>
<li>If the current record is marked for inclusion
in the simulated output, results are
written to the output matrix.</li>
<li>Continue to the next record in the individual.</li>
<li>Once the last record is processed in an
individual, a new individual is started.</li>
</ol>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="simulated-output.html"><span class="header-section-number">6</span> Simulated output</a></div>
<div class="next"><a href="steady-state.html"><span class="header-section-number">8</span> Steady state</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#section-sequence"><span class="header-section-number">7</span> Simulation sequence</a></li>
<li><a class="nav-link" href="#functions-to-call"><span class="header-section-number">7.1</span> Functions to call</a></li>
<li><a class="nav-link" href="#problem-initiation"><span class="header-section-number">7.2</span> Problem initiation</a></li>
<li><a class="nav-link" href="#subject-initiation"><span class="header-section-number">7.3</span> Subject initiation</a></li>
<li><a class="nav-link" href="#sequence-for-a-single-record"><span class="header-section-number">7.4</span> Sequence for a single record</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>mrgsolve User Guide</strong>" was written by Metrum Research Group. It was last built on 2023-02-06.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
