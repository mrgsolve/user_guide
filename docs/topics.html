<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 11 Topics | mrgsolve User Guide</title>
<meta name="author" content="Metrum Research Group">
<meta name="description" content="11.1 Annotated model specification Here is a complete annotated mrgsolve model. The goal was to get in several of the most common blocks that you might want to annotate. The different code blocks...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 11 Topics | mrgsolve User Guide">
<meta property="og:type" content="book">
<meta property="og:url" content="https://mrgsolve.github.io/user_guide/topics.html">
<meta property="og:description" content="11.1 Annotated model specification Here is a complete annotated mrgsolve model. The goal was to get in several of the most common blocks that you might want to annotate. The different code blocks...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 11 Topics | mrgsolve User Guide">
<meta name="twitter:site" content="@mrgsolve">
<meta name="twitter:description" content="11.1 Annotated model specification Here is a complete annotated mrgsolve model. The goal was to get in several of the most common blocks that you might want to annotate. The different code blocks...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bookstyle.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">mrgsolve User Guide</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="model-components.html"><span class="header-section-number">1</span> Model components</a></li>
<li><a class="" href="model-specification.html"><span class="header-section-number">2</span> Model specification</a></li>
<li><a class="" href="data-set-chapter.html"><span class="header-section-number">3</span> Input data sets</a></li>
<li><a class="" href="event-chapter.html"><span class="header-section-number">4</span> Event objects</a></li>
<li><a class="" href="matrix-chapter.html"><span class="header-section-number">5</span> Model Matrices</a></li>
<li><a class="" href="simulated-output.html"><span class="header-section-number">6</span> Simulated output</a></li>
<li><a class="" href="section-sequence.html"><span class="header-section-number">7</span> Simulation sequence</a></li>
<li><a class="" href="steady-state.html"><span class="header-section-number">8</span> Steady state</a></li>
<li><a class="" href="plugins.html"><span class="header-section-number">9</span> Plugins</a></li>
<li><a class="" href="mtime.html"><span class="header-section-number">10</span> Modeled events</a></li>
<li><a class="active" href="topics.html"><span class="header-section-number">11</span> Topics</a></li>
<li><a class="" href="q-and-a.html"><span class="header-section-number">12</span> Questions and Answers</a></li>
<li><a class="" href="install.html"><span class="header-section-number">13</span> Installation</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="topics" class="section level1" number="11">
<h1>
<span class="header-section-number">11</span> Topics<a class="anchor" aria-label="anchor" href="#topics"><i class="fas fa-link"></i></a>
</h1>
<div id="topic-annotated" class="section level2" number="11.1">
<h2>
<span class="header-section-number">11.1</span> Annotated model specification<a class="anchor" aria-label="anchor" href="#topic-annotated"><i class="fas fa-link"></i></a>
</h2>
<p>Here is a complete annotated <code>mrgsolve</code> model. The goal was to get in several
of the most common blocks that you might want to annotate. The different code
blocks are rendered here separately for clarity in presentation; but users
should include all relevant blocks in a single file (or R string).</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="topics.html#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>PROB</span>
<span id="cb357-2"><a href="topics.html#cb357-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-3"><a href="topics.html#cb357-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Final PK model</span></span>
<span id="cb357-4"><a href="topics.html#cb357-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-5"><a href="topics.html#cb357-5" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Author<span class="sc">:</span> Pmetrics Scientist</span>
<span id="cb357-6"><a href="topics.html#cb357-6" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Client<span class="sc">:</span> Pharmaco, Inc.</span>
<span id="cb357-7"><a href="topics.html#cb357-7" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Date<span class="sc">:</span> <span class="st">`</span><span class="at">r Sys.Date()</span><span class="st">`</span></span>
<span id="cb357-8"><a href="topics.html#cb357-8" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> NONMEM Run<span class="sc">:</span> <span class="dv">12345</span></span>
<span id="cb357-9"><a href="topics.html#cb357-9" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Structure<span class="sc">:</span> one compartment, first order absorption</span>
<span id="cb357-10"><a href="topics.html#cb357-10" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Implementation<span class="sc">:</span> closed form solutions</span>
<span id="cb357-11"><a href="topics.html#cb357-11" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Error model<span class="sc">:</span> Additive <span class="sc">+</span> proportional</span>
<span id="cb357-12"><a href="topics.html#cb357-12" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Covariates<span class="sc">:</span></span>
<span id="cb357-13"><a href="topics.html#cb357-13" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span> WT on clearance</span>
<span id="cb357-14"><a href="topics.html#cb357-14" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> SEX on volume</span>
<span id="cb357-15"><a href="topics.html#cb357-15" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> Random effects on<span class="sc">:</span> <span class="st">`</span><span class="at">CL</span><span class="st">`</span>, <span class="st">`</span><span class="at">V</span><span class="st">`</span>, <span class="st">`</span><span class="at">KA</span><span class="st">`</span></span></code></pre></div>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="topics.html#cb358-1" aria-hidden="true" tabindex="-1"></a>[PARAM] <span class="sc">@</span>annotated</span>
<span id="cb358-2"><a href="topics.html#cb358-2" aria-hidden="true" tabindex="-1"></a>TVCL <span class="sc">:</span> <span class="fl">1.1</span>   <span class="sc">:</span> <span class="fu">Clearance</span> (L<span class="sc">/</span>hr)</span>
<span id="cb358-3"><a href="topics.html#cb358-3" aria-hidden="true" tabindex="-1"></a>TVV  <span class="sc">:</span> <span class="fl">35.6</span>  <span class="sc">:</span> Volume of <span class="fu">distribution</span> (L)</span>
<span id="cb358-4"><a href="topics.html#cb358-4" aria-hidden="true" tabindex="-1"></a>TVKA <span class="sc">:</span> <span class="fl">1.35</span>  <span class="sc">:</span> Absorption rate <span class="fu">constant</span> (<span class="dv">1</span><span class="sc">/</span>hr)</span>
<span id="cb358-5"><a href="topics.html#cb358-5" aria-hidden="true" tabindex="-1"></a>WT   <span class="sc">:</span> <span class="dv">70</span>    <span class="sc">:</span> <span class="fu">Weight</span> (kg)</span>
<span id="cb358-6"><a href="topics.html#cb358-6" aria-hidden="true" tabindex="-1"></a>SEX  <span class="sc">:</span> <span class="dv">1</span>     <span class="sc">:</span> Male <span class="ot">=</span> <span class="dv">0</span>, Female <span class="dv">1</span></span>
<span id="cb358-7"><a href="topics.html#cb358-7" aria-hidden="true" tabindex="-1"></a>WTCL <span class="sc">:</span> <span class="fl">0.75</span>  <span class="sc">:</span> Exponent weight on CL</span>
<span id="cb358-8"><a href="topics.html#cb358-8" aria-hidden="true" tabindex="-1"></a>SEXV <span class="sc">:</span> <span class="fl">0.878</span> <span class="sc">:</span> Volume female<span class="sc">/</span>Volume male</span></code></pre></div>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="topics.html#cb359-1" aria-hidden="true" tabindex="-1"></a>[MAIN]</span>
<span id="cb359-2"><a href="topics.html#cb359-2" aria-hidden="true" tabindex="-1"></a>double CL <span class="ot">=</span> TVCL<span class="sc">*</span><span class="fu">pow</span>(WT<span class="sc">/</span><span class="dv">70</span>,WTCL)<span class="sc">*</span><span class="fu">exp</span>(ECL);</span>
<span id="cb359-3"><a href="topics.html#cb359-3" aria-hidden="true" tabindex="-1"></a>double V  <span class="ot">=</span> TVV <span class="sc">*</span><span class="fu">pow</span>(SEXVC,SEX)<span class="sc">*</span><span class="fu">exp</span>(EV);</span>
<span id="cb359-4"><a href="topics.html#cb359-4" aria-hidden="true" tabindex="-1"></a>double KA <span class="ot">=</span> TVKA<span class="sc">*</span><span class="fu">exp</span>(EKA);</span></code></pre></div>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="topics.html#cb360-1" aria-hidden="true" tabindex="-1"></a>[OMEGA] <span class="sc">@</span>name OMGA <span class="sc">@</span>correlation <span class="sc">@</span>block</span>
<span id="cb360-2"><a href="topics.html#cb360-2" aria-hidden="true" tabindex="-1"></a>ECL <span class="sc">:</span> <span class="fl">1.23</span> <span class="sc">:</span> Random effect on CL</span>
<span id="cb360-3"><a href="topics.html#cb360-3" aria-hidden="true" tabindex="-1"></a>EV  <span class="sc">:</span> <span class="fl">0.67</span> <span class="fl">0.4</span> <span class="sc">:</span> Random effect on V</span>
<span id="cb360-4"><a href="topics.html#cb360-4" aria-hidden="true" tabindex="-1"></a>EKA <span class="sc">:</span> <span class="fl">0.25</span> <span class="fl">0.87</span> <span class="fl">0.2</span> <span class="sc">:</span> Random effect on KA</span></code></pre></div>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="topics.html#cb361-1" aria-hidden="true" tabindex="-1"></a>[SIGMA] <span class="sc">@</span>name SGMA </span>
<span id="cb361-2"><a href="topics.html#cb361-2" aria-hidden="true" tabindex="-1"></a>PROP<span class="sc">:</span> <span class="fl">0.25</span> <span class="sc">:</span> Proportional residual error</span>
<span id="cb361-3"><a href="topics.html#cb361-3" aria-hidden="true" tabindex="-1"></a>ADD <span class="sc">:</span> <span class="dv">25</span>   <span class="sc">:</span> Additive residual error</span></code></pre></div>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="topics.html#cb362-1" aria-hidden="true" tabindex="-1"></a>[CMT]</span>
<span id="cb362-2"><a href="topics.html#cb362-2" aria-hidden="true" tabindex="-1"></a>GUT  <span class="sc">:</span> Dosing <span class="fu">compartment</span>  (mg)</span>
<span id="cb362-3"><a href="topics.html#cb362-3" aria-hidden="true" tabindex="-1"></a>CENT <span class="sc">:</span> Central <span class="fu">compartment</span> (mg)</span></code></pre></div>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="topics.html#cb363-1" aria-hidden="true" tabindex="-1"></a>[PKMODEL] ncmt <span class="ot">=</span> <span class="dv">1</span>, depot<span class="ot">=</span><span class="cn">TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="topics.html#cb364-1" aria-hidden="true" tabindex="-1"></a>[TABLE]</span>
<span id="cb364-2"><a href="topics.html#cb364-2" aria-hidden="true" tabindex="-1"></a>capture IPRED <span class="ot">=</span> CENT<span class="sc">/</span>V;</span>
<span id="cb364-3"><a href="topics.html#cb364-3" aria-hidden="true" tabindex="-1"></a>double DV <span class="ot">=</span> IPRED<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>PROP) <span class="sc">+</span> ADD;</span></code></pre></div>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="topics.html#cb365-1" aria-hidden="true" tabindex="-1"></a>[CAPTURE]</span>
<span id="cb365-2"><a href="topics.html#cb365-2" aria-hidden="true" tabindex="-1"></a>DV  <span class="sc">:</span> <span class="fu">Concentration</span> (mg<span class="sc">/</span>L)</span>
<span id="cb365-3"><a href="topics.html#cb365-3" aria-hidden="true" tabindex="-1"></a>ECL <span class="sc">:</span> Random effect on CL</span>
<span id="cb365-4"><a href="topics.html#cb365-4" aria-hidden="true" tabindex="-1"></a>CL  <span class="sc">:</span> Individual <span class="fu">clearance</span> (L<span class="sc">/</span>hr)</span></code></pre></div>
</div>
<div id="topic-init" class="section level2" number="11.2">
<h2>
<span class="header-section-number">11.2</span> Set initial conditions<a class="anchor" aria-label="anchor" href="#topic-init"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb366"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/metrumresearchgroup/mrgsolve">mrgsolve</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<div id="summary" class="section level3" number="11.2.1">
<h3>
<span class="header-section-number">11.2.1</span> Summary<a class="anchor" aria-label="anchor" href="#summary"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>
<code>mrgsolve</code> keeps a base list of compartments and initial conditions that
you can update <strong>either</strong> from <code>R</code> or from inside the model specification</li>
<li>When you use <code>$CMT</code>, the value in that base list is assumed to be 0 for
every compartment</li>
<li>
<code>mrgsolve</code> will by default use the values in that base list when starting
the problem</li>
<li>When only the base list is available, every individual will get the same
initial condition</li>
<li>You can <strong>override</strong> this base list by including code in <code>$MAIN</code> to set
the initial condition</li>
<li>Most often, you do this so that the initial is calculated as a function
of a parameter</li>
<li>For example, <code>$MAIN RESP_0 = KIN/KOUT;</code> when <code>KIN</code> and <code>KOUT</code> have some value in <code>$PARAM</code>
</li>
<li>This code in <code>$MAIN</code> overwrites the value in the base list for the current <code>ID</code>
</li>
<li>For typical PK/PD type models, we most frequently initialize in <code>$MAIN</code>
</li>
<li>This is equivalent to what you might do in your NONMEM model</li>
<li>For larger systems models, we often just set the initial value via the base list</li>
</ul>
</div>
<div id="make-a-model-only-to-examine-init-behavior" class="section level3" number="11.2.2">
<h3>
<span class="header-section-number">11.2.2</span> Make a model only to examine <code>init</code> behavior<a class="anchor" aria-label="anchor" href="#make-a-model-only-to-examine-init-behavior"><i class="fas fa-link"></i></a>
</h3>
<p>Note: <code>IFLAG</code> is my invention only for this demo. The demo is always responsible
for setting and interpreting the value (it is not reserved in any way and
<code>mrgsolve</code> does not control the value).</p>
<p>For this demo</p>
<ul>
<li>Compartment <code>A</code> initial condition defaults to 0</li>
<li>Compartment <code>A</code> initial condition will get set to <code>BASE</code> <strong>only</strong> if <code>IFLAG  &gt; 0</code>
</li>
<li>Compartment <code>A</code> always stays at the initial condition</li>
</ul>
<div class="sourceCode" id="cb367"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">code</span> <span class="op">&lt;-</span> <span class="st">'
$PARAM BASE=100, IFLAG = 0

$CMT A

$MAIN

if(IFLAG &gt; 0) A_0 = BASE;

$ODE dxdt_A = 0;
'</span></code></pre></div>
<div class="sourceCode" id="cb368"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mcode.html">mcode</a></span><span class="op">(</span><span class="st">"init"</span>,<span class="va">code</span><span class="op">)</span></code></pre></div>
<p><strong>Check the initial condition</strong></p>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/init.html">init</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<pre><code>. 
.  Model initial conditions (N=1):
.  name    value . name    value
.  A (1)   0     | . ...   .</code></pre>
<p>Note:</p>
<ul>
<li>We used <code>$CMT</code> in the model spec; that implies that the base initial
condition for <code>A</code> is set to 0</li>
<li>In this chunk, the code in <code>$MAIN</code> doesn’t get run because <code>IFLAG</code> is 0</li>
<li>So, if we don’t update something in <code>$MAIN</code> the initial condition is as we
set it in the base list</li>
</ul>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">mrgsim</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">plot</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-init-2-1.png" width="672"></div>
<p><strong>Next, we update the base initial condition for <code>A</code> to 50</strong></p>
<p>Note:</p>
<ul>
<li>The code in <code>$MAIN</code> still doesn’t get run because <code>IFLAG</code> is 0</li>
</ul>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/init.html">init</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">mrgsim</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">plot</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-init-3-1.png" width="672"></div>
<p><strong>Now, turn on <code>IFLAG</code></strong></p>
<p>Note:</p>
<ul>
<li>Now, that code in <code>$MAIN</code> gets run</li>
<li>
<code>A_0</code> is set to the value of <code>BASE</code>
</li>
</ul>
<div class="sourceCode" id="cb373"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span>IFLAG<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">mrgsim</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">plot</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-init-4-1.png" width="672"></div>
<div class="sourceCode" id="cb374"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span>IFLAG<span class="op">=</span><span class="fl">1</span>, BASE<span class="op">=</span><span class="fl">300</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">mrgsim</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">plot</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-init-5-1.png" width="672"></div>
</div>
<div id="example-pkpd-model-with-initial-condition" class="section level3" number="11.2.3">
<h3>
<span class="header-section-number">11.2.3</span> Example PK/PD model with initial condition<a class="anchor" aria-label="anchor" href="#example-pkpd-model-with-initial-condition"><i class="fas fa-link"></i></a>
</h3>
<p>Just to be clear, there is no need to set any sort of flag to set the initial
condition as seen here:</p>
<div class="sourceCode" id="cb375"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">code</span> <span class="op">&lt;-</span> <span class="st">'
$PARAM AUC=0, AUC50 = 75, KIN=200, KOUT=5

$CMT RESP

$MAIN 
RESP_0 = KIN/KOUT;

$ODE

dxdt_RESP = KIN*(1-AUC/(AUC50+AUC)) - KOUT*RESP;

'</span></code></pre></div>
<div class="sourceCode" id="cb376"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mcode.html">mcode</a></span><span class="op">(</span><span class="st">"init2"</span>, <span class="va">code</span><span class="op">)</span></code></pre></div>
<p>The initial condition is set to 40 per the values of <code>KIN</code> and <code>KOUT</code></p>
<div class="sourceCode" id="cb377"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">mrgsim</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">plot</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-init-7-1.png" width="672"></div>
<p>Even when we change <code>RESP_0</code> in <code>R</code>, the calculation in <code>$MAIN</code> gets the final say</p>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/init.html">init</a></span><span class="op">(</span>RESP<span class="op">=</span><span class="fl">1E9</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">mrgsim</span></code></pre></div>
<pre><code>. Model:  init2 
. Dim:    25 x 3 
. Time:   0 to 24 
. ID:     1 
.     ID time RESP
. 1:   1    0   40
. 2:   1    1   40
. 3:   1    2   40
. 4:   1    3   40
. 5:   1    4   40
. 6:   1    5   40
. 7:   1    6   40
. 8:   1    7   40</code></pre>
</div>
<div id="remember-calling-init-will-let-you-check-to-see-what-is-going-on" class="section level3" number="11.2.4">
<h3>
<span class="header-section-number">11.2.4</span> Remember: calling <code>init</code> will let you check to see what is going on<a class="anchor" aria-label="anchor" href="#remember-calling-init-will-let-you-check-to-see-what-is-going-on"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>It’s a good idea to get in the habit of doing this when things aren’t clear</li>
<li>
<code>init</code> first takes the base initial condition list, then calls <code>$MAIN</code> and
does any calculation you have in there; so the result is the calculated initials</li>
</ul>
<div class="sourceCode" id="cb380"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/init.html">init</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<pre><code>. 
.  Model initial conditions (N=1):
.  name       value . name    value
.  RESP (1)   0     | . ...   .</code></pre>
<div class="sourceCode" id="cb382"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span>KIN<span class="op">=</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">init</span></code></pre></div>
<pre><code>. 
.  Model initial conditions (N=1):
.  name       value . name    value
.  RESP (1)   0     | . ...   .</code></pre>
</div>
<div id="set-initial-conditions-via-idata" class="section level3" number="11.2.5">
<h3>
<span class="header-section-number">11.2.5</span> Set initial conditions via <code>idata</code><a class="anchor" aria-label="anchor" href="#set-initial-conditions-via-idata"><i class="fas fa-link"></i></a>
</h3>
<p>Go back to house model</p>
<div class="sourceCode" id="cb384"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mrgsolve</span><span class="fu">:::</span><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/house.html">house</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb385"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/init.html">init</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<pre><code>. 
.  Model initial conditions (N=3):
.  name       value . name       value
.  CENT (2)   0     | RESP (3)   50   
.  GUT (1)    0     | . ...      .</code></pre>
<p>Notes</p>
<ul>
<li>In <code>idata</code> (only), include a column with <code>CMT_0</code> (like you’d do in <code>$MAIN</code>).</li>
<li>When each ID is simulated, the <code>idata</code> value will override the base initial
list for that subject.</li>
<li>But note that if <code>CMT_0</code> is set in <code>$MAIN</code>, that will override the <code>idata</code>
update.</li>
</ul>
<div class="sourceCode" id="cb387"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/expand.idata.html">expand.idata</a></span><span class="op">(</span>CENT_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">25</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb388"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">idata</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">head</span></code></pre></div>
<pre><code>.   ID CENT_0
. 1  1      0
. 2  2      1
. 3  3      2
. 4  4      3
. 5  5      4
. 6  6      5</code></pre>
<div class="sourceCode" id="cb390"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span> 
  <span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/idata_set.html">idata_set</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="fl">40</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb391"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">CENT</span><span class="op">~</span><span class="va">.</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-init-11-1.png" width="672"></div>
</div>
</div>
<div id="topic-parameter-update" class="section level2" number="11.3">
<h2>
<span class="header-section-number">11.3</span> Updating parameters<a class="anchor" aria-label="anchor" href="#topic-parameter-update"><i class="fas fa-link"></i></a>
</h2>
<p>The parameter list was introduced in section <a href="model-components.html#component-param">1.1</a> and the
<code>$PARAM</code> code block was shown in <a href="model-specification.html#block-param">2.2.4</a>. Once a model is compiled,
the names and number of parameters in a model is fixed. However, the values of
parameters can be changed: parameters may be updated either by the user (in <code>R</code>)
or by <code>mrgsolve</code> (in the <code>C++</code> simulation engine, as the simulation proceeds).</p>
<ul>
<li>To update in <code>R</code>, use the <code><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param()</a></code> function (see examples below)</li>
<li>To have <code>mrgsolve</code> update the parameters, attach columns to your data set
(either <code>data_set</code> or <code>idata_set</code>) with the same name as items in the parameter
list</li>
</ul>
<p>Both of these methods are discussed and illustrated in the following sections.</p>
<div id="parameter-update-hierarchy" class="section level3" number="11.3.1">
<h3>
<span class="header-section-number">11.3.1</span> Parameter update hierarchy<a class="anchor" aria-label="anchor" href="#parameter-update-hierarchy"><i class="fas fa-link"></i></a>
</h3>
<p>As we noted above, new parameter values can come from three potential sources:</p>
<ol style="list-style-type: decimal">
<li>Modification of the (base) parameter list</li>
<li>A column in an <code>idata_set</code> that has the same name as a model parameter</li>
<li>A column in a <code>data_set</code> that has the same name as a model parameter</li>
</ol>
<p>These sources for new parameter values are discussed below. We note here that
the sources listed above are listed in the order of the parameter update
<em>hierarchy</em>. So, the base parameter list provides the value by default. A
parameter value coming from an <code>idata_set</code> will override the value in the base
list. And a parameter value coming from a <code>data_set</code> will override the value
coming from the base list or an <code>idata_set</code> (in case a parameter is listed in
both the <code>idata_set</code> and the <code>data_set</code>). In other words, the hierarchy is:</p>
<ol style="list-style-type: decimal">
<li>base parameter list is the default</li>
<li>the <code>idata_set</code> overrides the base list</li>
<li>the <code>data_set</code> overrides the <code>idata_set</code> and the base list</li>
</ol>
<p>The parameter update hierarchy is discussed in the following sections.</p>
<p><strong>Base parameter set</strong></p>
<ul>
<li>Every model has a base set of “parameters”</li>
<li>These are named and set in <code>$PARAM</code>
</li>
<li>Parameters can only get into the parameter list in <code>$PARAM</code> (or <code>$THETA</code>)</li>
<li>No changing the names or numbers of parameters once the model is compiled</li>
<li>But, several ways to change the values</li>
</ul>
<div class="sourceCode" id="cb392"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">code</span> <span class="op">&lt;-</span> <span class="st">'
$VCMT KYLE
$PARAM CL = 1.1, VC=23.1, KA=1.7, KM=10
$CAPTURE CL VC KA KM
'</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mcode.html">mcode</a></span><span class="op">(</span><span class="st">"tmp"</span>, <span class="va">code</span>, warn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb393"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<pre><code>. 
.  Model parameters (N=4):
.  name value . name value
.  CL   1.1   | KM   10   
.  KA   1.7   | VC   23.1</code></pre>
<p><strong>The base parameter set is the default</strong></p>
<p>The base parameter set allows you to run the model without entering any other
data; there are some default values in place.</p>
<p><strong>The parameters in the base list can be changed or updated in <code>R</code></strong></p>
<p>Use the <code><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param()</a></code> function to both set and get:</p>
<div class="sourceCode" id="cb395"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">mod</span>, CL<span class="op">=</span><span class="fl">2.1</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb396"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<pre><code>. 
.  Model parameters (N=4):
.  name value . name value
.  CL   2.1   | KM   10   
.  KA   1.7   | VC   23.1</code></pre>
<p>But whatever you’ve done in <code>R</code>, there is a base set (with values) to use.
See section <a href="topics.html#topic-parameter-update-base">11.3.2</a> for a more detailed discussion
of using <code><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param()</a></code> to updated the base list.</p>
<p><strong>Parameters can also be updated during the simulation run</strong></p>
<p>Parameters can be updated by putting columns in <code>idata</code> set or <code>data_set</code> that
have the same name as one of the parameters in the parameter list. But there
is no changing values in the base parameter set once the simulation starts.<br>
That is, the following model specification will not compile:</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb398-1"><a href="topics.html#cb398-1" aria-hidden="true" tabindex="-1"></a>$PARAM CL <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb398-2"><a href="topics.html#cb398-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-3"><a href="topics.html#cb398-3" aria-hidden="true" tabindex="-1"></a>$MAIN CL <span class="op">=</span> <span class="dv">3</span><span class="op">;</span> <span class="co">// ERROR</span></span></code></pre></div>
<p>You cannot over-write the value of a parameter in the model specification.<br>
Let <code>mrgsolve</code> do the updating.</p>
<p><code>mrgsolve</code> always reverts to the base parameter set when starting work on a
new individual.</p>
<p><strong>Parameters updated from <code>idata_set</code></strong></p>
<p>When <code>mrgsolve</code> finds parameters in <code>idata</code>, it will update the base parameter
list with those parameters prior to starting that individual.</p>
<div class="sourceCode" id="cb399"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">exidata</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">exidata</span><span class="op">)</span></code></pre></div>
<pre><code>.   ID    CL    VC     KA KOUT  IC50 FOO
. 1  1 1.050 47.80 0.8390 2.45 1.280   4
. 2  2 0.730 30.10 0.0684 2.51 1.840   6
. 3  3 2.820 23.80 0.1180 3.88 2.480   5
. 4  4 0.552 26.30 0.4950 1.18 0.977   2
. 5  5 0.483  4.36 0.1220 2.35 0.483  10
. 6  6 3.620 39.80 0.1260 1.89 4.240   1</code></pre>
<p>Notice that there are several columns in <code>exidata</code> that match up with the names
in the parameter list</p>
<div class="sourceCode" id="cb401"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">exidata</span><span class="op">)</span></code></pre></div>
<pre><code>. [1] "ID"   "CL"   "VC"   "KA"   "KOUT" "IC50" "FOO"</code></pre>
<div class="sourceCode" id="cb403"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>. [1] "CL" "VC" "KA" "KM"</code></pre>
<p>The matching names tell <code>mrgsolve</code> to update, assigning each individual
their individual parameter.</p>
<div class="sourceCode" id="cb405"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span> 
  <span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/idata_set.html">idata_set</a></span><span class="op">(</span><span class="va">exidata</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="op">-</span><span class="fl">1</span> , add<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb406"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span></code></pre></div>
<pre><code>. Model:  tmp 
. Dim:    20 x 7 
. Time:   0 to 2 
. ID:     10 
.     ID time KYLE    CL   VC     KA KM
. 1:   1    0    0 1.050 47.8 0.8390 10
. 2:   1    2    0 1.050 47.8 0.8390 10
. 3:   2    0    0 0.730 30.1 0.0684 10
. 4:   2    2    0 0.730 30.1 0.0684 10
. 5:   3    0    0 2.820 23.8 0.1180 10
. 6:   3    2    0 2.820 23.8 0.1180 10
. 7:   4    0    0 0.552 26.3 0.4950 10
. 8:   4    2    0 0.552 26.3 0.4950 10</code></pre>
<p><strong>Parameters updated from <code>data_set</code></strong></p>
<p>Like an <code>idata</code> set, we can put parameters on a <code>data</code> set</p>
<div class="sourceCode" id="cb408"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/expand.idata.html">expand.ev</a></span><span class="op">(</span>amt<span class="op">=</span><span class="fl">0</span>, CL<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, VC<span class="op">=</span><span class="fl">30</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb409"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span> 
  <span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/data_set.html">data_set</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="va">obsonly</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, add<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb410"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span></code></pre></div>
<pre><code>. Model:  tmp 
. Dim:    6 x 7 
. Time:   0 to 2 
. ID:     3 
.     ID time KYLE CL VC  KA KM
. 1:   1    0    0  1 30 1.7 10
. 2:   1    2    0  1 30 1.7 10
. 3:   2    0    0  2 30 1.7 10
. 4:   2    2    0  2 30 1.7 10
. 5:   3    0    0  3 30 1.7 10
. 6:   3    2    0  3 30 1.7 10</code></pre>
<p>This is how we do time-varying parameters:</p>
<div class="sourceCode" id="cb412"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/deprecated.html">data_frame</a></span><span class="op">(</span>CL<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>evid<span class="op">=</span><span class="fl">0</span>,ID<span class="op">=</span><span class="fl">1</span>,cmt<span class="op">=</span><span class="fl">1</span>,time<span class="op">=</span><span class="va">CL</span><span class="op">-</span><span class="fl">1</span>,amt<span class="op">=</span><span class="fl">0</span><span class="op">)</span></code></pre></div>
<pre><code>. Warning: `data_frame()` was deprecated in tibble 1.1.0.
. Please use `tibble()` instead.
. This warning is displayed once every 8 hours.
. Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb414"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/data_set.html">data_set</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>. Model:  tmp 
. Dim:    5 x 7 
. Time:   0 to 4 
. ID:     1 
.     ID time KYLE CL   VC  KA KM
. 1:   1    0    0  1 23.1 1.7 10
. 2:   1    1    0  2 23.1 1.7 10
. 3:   1    2    0  3 23.1 1.7 10
. 4:   1    3    0  4 23.1 1.7 10
. 5:   1    4    0  5 23.1 1.7 10</code></pre>
<p>For more information on time-varying covariates
(parameters), see sections <a href="topics.html#topics-time-varying">11.8</a> and <a href="section-sequence.html#section-sequence">7</a>.</p>
<p><strong>Parameters are carried back when first record isn’t at <code>time == 0</code></strong></p>
<p>What about this?</p>
<div class="sourceCode" id="cb416"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/expand.idata.html">expand.ev</a></span><span class="op">(</span>amt<span class="op">=</span><span class="fl">100</span>,time<span class="op">=</span><span class="fl">24</span>,CL<span class="op">=</span><span class="fl">5</span>,VC<span class="op">=</span><span class="fl">32</span><span class="op">)</span>
<span class="va">data</span></code></pre></div>
<pre><code>.   ID time amt cmt evid CL VC
. 1  1   24 100   1    1  5 32</code></pre>
<p>The first <code>data</code> record happens at <code>time==24</code></p>
<div class="sourceCode" id="cb418"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/data_set.html">data_set</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, add<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>. Model:  tmp 
. Dim:    3 x 7 
. Time:   0 to 24 
. ID:     1 
.     ID time KYLE CL VC  KA KM
. 1:   1    0    0  5 32 1.7 10
. 2:   1    2    0  5 32 1.7 10
. 3:   1   24  100  5 32 1.7 10</code></pre>
<p>Since the data set doesn’t start until <code>time==5</code>, we might think that <code>CL</code>
doesn’t change from the base parameter set until then.</p>
<p>But by default, <code>mrgsolve</code> carries those parameter values back to the start of
the simulation. This is by design … by far the more useful configuration.</p>
<p>If you wanted the base parameter set in play until that first data set record,
do this:</p>
<div class="sourceCode" id="cb420"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/data_set.html">data_set</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="op">-</span><span class="fl">1</span>,add<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span>, filbak<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>. Model:  tmp 
. Dim:    3 x 7 
. Time:   0 to 24 
. ID:     1 
.     ID time KYLE CL VC  KA KM
. 1:   1    0    0  5 32 1.7 10
. 2:   1    2    0  5 32 1.7 10
. 3:   1   24  100  5 32 1.7 10</code></pre>
<p>Will this work?</p>
<div class="sourceCode" id="cb422"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">idata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"expand.idata"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">idata</span></code></pre></div>
<pre><code>.   ID  CL   VC  KA KM
. 1  1 2.1 23.1 1.7 10</code></pre>
<p>Here, we’ll pass in <strong>both</strong> <code>data_set</code> and <code>idata_set</code> and they have
conflicting values for the parameters.</p>
<div class="sourceCode" id="cb424"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/data_set.html">data_set</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/idata_set.html">idata_set</a></span><span class="op">(</span><span class="va">idata</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="op">-</span><span class="fl">1</span>,add<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>. Model:  tmp 
. Dim:    3 x 7 
. Time:   0 to 24 
. ID:     1 
.     ID time KYLE CL VC  KA KM
. 1:   1    0    0  5 32 1.7 10
. 2:   1    2    0  5 32 1.7 10
. 3:   1   24  100  5 32 1.7 10</code></pre>
<p>The data set always gets the last word.</p>
</div>
<div id="topic-parameter-update-base" class="section level3" number="11.3.2">
<h3>
<span class="header-section-number">11.3.2</span> Updating the base parameter list<a class="anchor" aria-label="anchor" href="#topic-parameter-update-base"><i class="fas fa-link"></i></a>
</h3>
<p>From the previous section</p>
<div class="sourceCode" id="cb426"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<pre><code>. 
.  Model parameters (N=4):
.  name value . name value
.  CL   2.1   | KM   10   
.  KA   1.7   | VC   23.1</code></pre>
<p><strong>Update with <code>name-value</code> pairs</strong></p>
<p>We can call <code><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param()</a></code> to update the model object, directly naming the parameter
to update and the new value to take</p>
<div class="sourceCode" id="cb428"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span>CL <span class="op">=</span> <span class="fl">777</span>, KM <span class="op">=</span> <span class="fl">999</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">param</span></code></pre></div>
<pre><code>. 
.  Model parameters (N=4):
.  name value . name value
.  CL   777   | KM   999  
.  KA   1.7   | VC   23.1</code></pre>
<p>The parameter list can also be updated by scanning the names in a list</p>
<div class="sourceCode" id="cb430"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">what</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>CL <span class="op">=</span> <span class="fl">555</span>, VC <span class="op">=</span> <span class="fl">888</span>, KYLE <span class="op">=</span> <span class="fl">123</span>, MN <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>

<span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">what</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">param</span></code></pre></div>
<pre><code>. 
.  Model parameters (N=4):
.  name value . name value
.  CL   555   | KM   10   
.  KA   1.7   | VC   888</code></pre>
<p><code>mrgsolve</code> looks at the names to drive the update. <code>KYLE</code> (a compartment name)
and <code>MN</code> (not in the model anywhere) are ignored.</p>
<p>Alternatively, we can pick a row from a data frame to provide the input for the
update</p>
<div class="sourceCode" id="cb432"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/deprecated.html">data_frame</a></span><span class="op">(</span>CL<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span>,<span class="fl">10</span><span class="op">)</span>, VC<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>,<span class="fl">12</span><span class="op">)</span>, KTB<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">13</span>,<span class="fl">14</span><span class="op">)</span><span class="op">)</span>

<span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">param</span></code></pre></div>
<pre><code>. 
.  Model parameters (N=4):
.  name value . name value
.  CL   10    | KM   10   
.  KA   1.7   | VC   12</code></pre>
<p>Here the second row in the data frame drives the update. Other names are ignored.</p>
<p>A warning will be issued if an update is attempted, but no matching names are found</p>
<div class="sourceCode" id="cb434"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/param.html">param</a></span><span class="op">(</span>ZIP <span class="op">=</span> <span class="fl">1</span>, CODE <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="va">param</span></code></pre></div>
<pre><code>Warning message:
Found nothing to update: param </code></pre>
</div>
</div>
<div id="topic-tgrid" class="section level2" number="11.4">
<h2>
<span class="header-section-number">11.4</span> Time grid objects<a class="anchor" aria-label="anchor" href="#topic-tgrid"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Simulation times in <code>mrgsolve</code></strong></p>
<div class="sourceCode" id="cb436"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mrgsolve</span><span class="fu">:::</span><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/house.html">house</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/Req.html">Req</a></span><span class="op">(</span><span class="va">CP</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/ev.html">ev</a></span><span class="op">(</span>amt<span class="op">=</span><span class="fl">1000</span>,ii<span class="op">=</span><span class="fl">24</span>, addl<span class="op">=</span><span class="fl">1000</span><span class="op">)</span> </code></pre></div>
<p><code>mrgsolve</code> keeps track of a simulation <code>start</code> and <code>end</code> time and a fixed size
step between <code>start</code> and <code>end</code> (called <code>delta</code>). <code>mrgsolve</code> also keeps an
arbitrary vector of simulation times called <code>add</code>.</p>
<div class="sourceCode" id="cb437"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="fl">4</span>,delta<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">9</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="va">as.data.frame</span></code></pre></div>
<pre><code>.   ID time       CP
. 1  1    0  0.00000
. 2  1    0  0.00000
. 3  1    2 42.47580
. 4  1    4 42.28701
. 5  1    7 36.75460
. 6  1    9 33.26649
. 7  1   50 60.97754</code></pre>
<p><strong><code>tgrid</code> objects</strong></p>
<p>The <code>tgrid</code> object abstracts this setup and allows us to make complicated
sampling designs from elementary building blocks.</p>
<p><strong>Make a day 1 sampling with intensive sampling around the peak and sparser otherwise</strong></p>
<div class="sourceCode" id="cb439"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">peak1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/tgrid.html">tgrid</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">0.1</span><span class="op">)</span>
<span class="va">sparse1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/tgrid.html">tgrid</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span>,<span class="fl">4</span><span class="op">)</span></code></pre></div>
<p><strong>Use the <code>c</code> operator to combine simpler designs into more complicated designs</strong></p>
<div class="sourceCode" id="cb440"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">day1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">peak1</span>,<span class="va">sparse1</span><span class="op">)</span></code></pre></div>
<p>Check this by calling <code>stime</code></p>
<div class="sourceCode" id="cb441"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/stime.html">stime</a></span><span class="op">(</span><span class="va">day1</span><span class="op">)</span></code></pre></div>
<pre><code>.  [1]  0.0  1.0  1.1  1.2  1.3  1.4  1.5  1.6  1.7  1.8  1.9  2.0  2.1  2.2  2.3
. [16]  2.4  2.5  2.6  2.7  2.8  2.9  3.0  3.1  3.2  3.3  3.4  3.5  3.6  3.7  3.8
. [31]  3.9  4.0  8.0 12.0 16.0 20.0 24.0</code></pre>
<p>Pass this object in to <code>mrgsim</code> as <code>tgrid</code>. It will override the default
<code>start/end/delta/add</code> sequence.</p>
<div class="sourceCode" id="cb443"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>tgrid<span class="op">=</span><span class="va">day1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">'b'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-tgrid-1-1.png" width="672"></div>
<p><strong>Now, look at both day 1 and day 10</strong>:</p>
<p>Adding a number to a <code>tgrid</code> object will offset those times by that amount.</p>
<div class="sourceCode" id="cb444"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">day1</span>, <span class="va">day1</span><span class="op">+</span><span class="fl">10</span><span class="op">*</span><span class="fl">24</span><span class="op">)</span>

<span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>tgrid<span class="op">=</span><span class="va">des</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">'b'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-tgrid-2-1.png" width="672"></div>
<p>Pick up day 5 as well</p>
<div class="sourceCode" id="cb445"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">des</span>, <span class="va">day1</span><span class="op">+</span><span class="fl">5</span><span class="op">*</span><span class="fl">24</span><span class="op">)</span>

<span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>tgrid<span class="op">=</span><span class="va">des</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">'b'</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-tgrid-3-1.png" width="672"></div>
</div>
<div id="topic-designs" class="section level2" number="11.5">
<h2>
<span class="header-section-number">11.5</span> Individualized sampling designs<a class="anchor" aria-label="anchor" href="#topic-designs"><i class="fas fa-link"></i></a>
</h2>
<p>Here is a PopPK model and a full <code>data_set</code>.</p>
<div class="sourceCode" id="cb446"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mrgsolve</span><span class="fu">:::</span><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/house.html">house</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">exTheoph</span><span class="op">)</span>

<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">exTheoph</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></code></pre></div>
<pre><code>.   ID   WT Dose time  conc cmt  amt evid
. 1  1 79.6 4.02 0.00  0.00   1 4.02    1
. 2  1 79.6 4.02 0.25  2.84   0 0.00    0
. 3  1 79.6 4.02 0.57  6.57   0 0.00    0
. 4  1 79.6 4.02 1.12 10.50   0 0.00    0
. 5  1 79.6 4.02 2.02  9.66   0 0.00    0
. 6  1 79.6 4.02 3.82  8.58   0 0.00    0</code></pre>
<div class="sourceCode" id="cb448"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/Req.html">Req</a></span><span class="op">(</span><span class="va">CP</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/carry_out.html">carry.out</a></span><span class="op">(</span><span class="va">a.u.g</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/data_set.html">data_set</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="va">obsaug</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="va">mrgsim</span> </code></pre></div>
<pre><code>. Model:  housemodel 
. Dim:    5904 x 4 
. Time:   0 to 120 
. ID:     12 
.     ID time a.u.g      CP
. 1:   1 0.00     1 0.00000
. 2:   1 0.00     0 0.00000
. 3:   1 0.25     1 0.04552
. 4:   1 0.25     0 0.04552
. 5:   1 0.50     1 0.07870
. 6:   1 0.57     0 0.08624
. 7:   1 0.75     1 0.10274
. 8:   1 1.00     1 0.12001</code></pre>
<p>Now, define two time grid objects: <code>des1</code> runs from 0 to 24 and <code>des2</code> runs from
0 to 96, both every hour.</p>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">des1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/tgrid.html">tgrid</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">des2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/tgrid.html">tgrid</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">96</span>,<span class="fl">1</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/stime.html">stime</a></span><span class="op">(</span><span class="va">des1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>. [1]  0 24</code></pre>
<div class="sourceCode" id="cb452"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/stime.html">stime</a></span><span class="op">(</span><span class="va">des2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>. [1]  0 96</code></pre>
<p>Now, derive an <code>idata_set</code> after adding a grouping column (<code>GRP</code>) that splits
the data set into two groups</p>
<div class="sourceCode" id="cb454"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">df</span>, GRP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>

<span class="va">id</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">ID</span>,<span class="va">GRP</span><span class="op">)</span> 

<span class="va">id</span></code></pre></div>
<pre><code>.    ID GRP
. 1   1   0
. 2   2   0
. 3   3   0
. 4   4   0
. 5   5   0
. 6   6   1
. 7   7   1
. 8   8   1
. 9   9   1
. 10 10   1
. 11 11   1
. 12 12   1</code></pre>
<p>Now, we have two groups in <code>GRP</code> in <code>idata_set</code> and we have two <code>tgrid</code> objects.</p>
<ul>
<li>Pass in both the <code>idata_set</code> and the <code>data_set</code>
</li>
<li>Call <code>design</code>
</li>
<li>Identify <code>GRP</code> as <code>descol</code>; the column <strong>must</strong> be in <code>idata_set</code>
</li>
<li>Pass in a list of designs; it <strong>must</strong> be at least two because there are two levels in <code>GRP</code>
</li>
</ul>
<p>When we simulate, the individuals in <code>GRP 1</code> will get <code>des1</code> and those in <code>GRP 2</code> will get <code>des2</code></p>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span> 
  <span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/Req.html">Req</a></span><span class="op">(</span><span class="va">CP</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/carry_out.html">carry.out</a></span><span class="op">(</span><span class="va">a.u.g</span>,<span class="va">GRP</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/idata_set.html">idata_set</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/data_set.html">data_set</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/design.html">design</a></span><span class="op">(</span>descol<span class="op">=</span><span class="st">"GRP"</span>, deslist<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">des1</span>,<span class="va">des2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="va">obsaug</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span>
  <span class="va">mrgsim</span> 

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">CP</span><span class="op">~</span><span class="va">time</span><span class="op">|</span><span class="va">GRP</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="user-guide_files/figure-html/topic-design-1-1.png" width="672"></div>
</div>
<div id="some-helpful-c" class="section level2" number="11.6">
<h2>
<span class="header-section-number">11.6</span> Some helpful <code>C++</code><a class="anchor" aria-label="anchor" href="#some-helpful-c"><i class="fas fa-link"></i></a>
</h2>
<p>Recall that the following blocks require valid <code>C++</code> code:</p>
<ol style="list-style-type: decimal">
<li><code>$PREAMBLE</code></li>
<li><code>$MAIN</code></li>
<li><code>$ODE</code></li>
<li><code>$TABLE</code></li>
<li><code>$GLOBAL</code></li>
<li><code>$PRED</code></li>
</ol>
<p>We don’t want users to have to be proficient in <code>C++</code> to be able to use mrgsolve.
and we’ve created several macros to help simplify things as much as possible.<br>
However, it is required to become familiar with some of the basics and certainly
additional knowledge of how to do more than just the basics will help you
code more and more complicated models in mrgsolve.</p>
<p>There are an unending stream of tutorials, references and help pages on <code>C++</code>
to be found on the interweb. As a general source, I like to use
<a href="https://en.cppreference.com/" class="uri">https://en.cppreference.com/</a>. But, again, there many other good resources
out there that can suit your needs.</p>
<p>The rest of this section provides a very general reference of the types of
<code>C++</code> code and functions that you might be using in your model.</p>
<div id="semi-colons" class="section level3" number="11.6.1">
<h3>
<span class="header-section-number">11.6.1</span> Semi-colons<a class="anchor" aria-label="anchor" href="#semi-colons"><i class="fas fa-link"></i></a>
</h3>
<p>Every statement in <code>C++</code> must end with a semi-colon. For example;</p>
<div class="sourceCode" id="cb457"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb457-1"><a href="topics.html#cb457-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span> MAIN <span class="op">]</span> </span>
<span id="cb457-2"><a href="topics.html#cb457-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> CL <span class="op">=</span> exp<span class="op">(</span>log_TVCL <span class="op">+</span> ETA<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb458-1"><a href="topics.html#cb458-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span> ODE <span class="op">]</span> </span>
<span id="cb458-2"><a href="topics.html#cb458-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-3"><a href="topics.html#cb458-3" aria-hidden="true" tabindex="-1"></a>dxdt_DEPOT <span class="op">=</span> <span class="op">-</span>KA <span class="op">*</span> DEPOT<span class="op">;</span></span></code></pre></div>
</div>
<div id="if-else" class="section level3" number="11.6.2">
<h3>
<span class="header-section-number">11.6.2</span> if-else<a class="anchor" aria-label="anchor" href="#if-else"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb459"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb459-1"><a href="topics.html#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>a <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> b <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb460"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb460-1"><a href="topics.html#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>a<span class="op">==</span><span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb460-2"><a href="topics.html#cb460-2" aria-hidden="true" tabindex="-1"></a>  b <span class="op">=</span> <span class="dv">2</span><span class="op">;</span>  </span>
<span id="cb460-3"><a href="topics.html#cb460-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb461"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb461-1"><a href="topics.html#cb461-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>a <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb461-2"><a href="topics.html#cb461-2" aria-hidden="true" tabindex="-1"></a>  b<span class="op">=</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb461-3"><a href="topics.html#cb461-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb461-4"><a href="topics.html#cb461-4" aria-hidden="true" tabindex="-1"></a>  b<span class="op">=</span><span class="dv">3</span><span class="op">;</span></span>
<span id="cb461-5"><a href="topics.html#cb461-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is the equivalent of <code>x &lt;- ifelse(c == 4, 8, 10)</code> in R</p>
<div class="sourceCode" id="cb462"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb462-1"><a href="topics.html#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> x <span class="op">=</span> c <span class="op">==</span> <span class="dv">4</span> <span class="op">?</span> <span class="dv">8</span> <span class="op">:</span> <span class="dv">10</span><span class="op">;</span></span></code></pre></div>
</div>
<div id="functions-1" class="section level3" number="11.6.3">
<h3>
<span class="header-section-number">11.6.3</span> Functions<a class="anchor" aria-label="anchor" href="#functions-1"><i class="fas fa-link"></i></a>
</h3>
<p>The following functions are hopefully understandable based on the function
name. Consult <a href="https://cppreference.com" class="uri">https://cppreference.com</a> for further details.</p>
<div class="sourceCode" id="cb463"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb463-1"><a href="topics.html#cb463-1" aria-hidden="true" tabindex="-1"></a><span class="er"># base^exponent</span></span>
<span id="cb463-2"><a href="topics.html#cb463-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> d <span class="op">=</span> pow<span class="op">(</span>base<span class="op">,</span>exponent<span class="op">);</span></span>
<span id="cb463-3"><a href="topics.html#cb463-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-4"><a href="topics.html#cb463-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> e <span class="op">=</span> exp<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb463-5"><a href="topics.html#cb463-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-6"><a href="topics.html#cb463-6" aria-hidden="true" tabindex="-1"></a><span class="er"># absolute value</span></span>
<span id="cb463-7"><a href="topics.html#cb463-7" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> f <span class="op">=</span> fabs<span class="op">(-</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb463-8"><a href="topics.html#cb463-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-9"><a href="topics.html#cb463-9" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> g <span class="op">=</span> sqrt<span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb463-10"><a href="topics.html#cb463-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-11"><a href="topics.html#cb463-11" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> h <span class="op">=</span> log<span class="op">(</span><span class="dv">6</span><span class="op">);</span></span>
<span id="cb463-12"><a href="topics.html#cb463-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-13"><a href="topics.html#cb463-13" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> i <span class="op">=</span> log10<span class="op">(</span><span class="dv">7</span><span class="op">);</span></span>
<span id="cb463-14"><a href="topics.html#cb463-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-15"><a href="topics.html#cb463-15" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> j <span class="op">=</span> floor<span class="op">(</span><span class="fl">4.2</span><span class="op">);</span></span>
<span id="cb463-16"><a href="topics.html#cb463-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-17"><a href="topics.html#cb463-17" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> k <span class="op">=</span> ceil<span class="op">(</span><span class="fl">4.2</span><span class="op">);</span></span>
<span id="cb463-18"><a href="topics.html#cb463-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-19"><a href="topics.html#cb463-19" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> l <span class="op">=</span> std<span class="op">::</span>max<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span>
<span id="cb463-20"><a href="topics.html#cb463-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-21"><a href="topics.html#cb463-21" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> m <span class="op">=</span> std<span class="op">::</span>min<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">);</span></span></code></pre></div>
</div>
<div id="integer-division" class="section level3" number="11.6.4">
<h3>
<span class="header-section-number">11.6.4</span> Integer division<a class="anchor" aria-label="anchor" href="#integer-division"><i class="fas fa-link"></i></a>
</h3>
<p>The user is warned about division with two integers. In <code>R</code>, the following
statement evaluates to <code>0.75</code>:</p>
<div class="sourceCode" id="cb464"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fl">3</span><span class="op">/</span><span class="fl">4</span></code></pre></div>
<pre><code>. [1] 0.75</code></pre>
<p>But in <code>C++</code> it evaluates to 0:</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb466-1"><a href="topics.html#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> x <span class="op">=</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span><span class="op">;</span></span></code></pre></div>
<p>This is because both the <code>3</code> and the <code>4</code> are taken as integer literals. This
produces the same result as</p>
<div class="sourceCode" id="cb467"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb467-1"><a href="topics.html#cb467-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> a <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb467-2"><a href="topics.html#cb467-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> b <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb467-3"><a href="topics.html#cb467-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> x <span class="op">=</span> a<span class="op">/</span>b<span class="op">;</span></span></code></pre></div>
<p>When one integer is divided by another integer, the remainder is discarded (the
result is rounded down). This is the way <code>C++</code> works. The user is warned.</p>
<p>Note that parameters in mrgsolve are <code>doubles</code> so this will evaluate to <code>0.75</code></p>
<div class="sourceCode" id="cb468"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb468-1"><a href="topics.html#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span> PARAM <span class="op">]</span> a <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb468-2"><a href="topics.html#cb468-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-3"><a href="topics.html#cb468-3" aria-hidden="true" tabindex="-1"></a><span class="op">[</span> MAIN <span class="op">]</span> </span>
<span id="cb468-4"><a href="topics.html#cb468-4" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> x <span class="op">=</span> a<span class="op">/</span><span class="dv">4</span><span class="op">;</span></span></code></pre></div>
<p>Since <code>a</code> is a parameter the operation of <code>a/4</code> is not integer division and
the result is <code>0.75</code>.</p>
<p>Unless you are already very comfortable with this concept, users are encouraged
to add <code>.0</code> suffix to any literal number <strong>written as C++ code</strong>. For example:</p>
<div class="sourceCode" id="cb469"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb469-1"><a href="topics.html#cb469-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> x <span class="op">=</span> <span class="fl">3.0</span> <span class="op">/</span> <span class="fl">4.0</span><span class="op">;</span></span></code></pre></div>
<p>I think it’s fair to say that the vast majority of time you want this to
evaluate to <code>0.75</code> and writing <code>3.0/4.0</code> rather than <code>3/4</code> will ensure you
will not discard any remainder here.</p>
<p>If you would like to experiment with these concepts, try running this code</p>
<div class="sourceCode" id="cb470"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/metrumresearchgroup/mrgsolve">mrgsolve</a></span><span class="op">)</span>

<span class="va">code</span> <span class="op">&lt;-</span> <span class="st">'
[ param ] a = 3

[ main ] 
capture x = 3/4;
capture y = 3.0/4.0;
capture z = a/4;
'</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mcode.html">mcode</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="va">code</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<pre><code>. Model:  foo 
. Dim:    25 x 5 
. Time:   0 to 24 
. ID:     1 
.     ID time x    y    z
. 1:   1    0 0 0.75 0.75
. 2:   1    1 0 0.75 0.75
. 3:   1    2 0 0.75 0.75
. 4:   1    3 0 0.75 0.75
. 5:   1    4 0 0.75 0.75
. 6:   1    5 0 0.75 0.75
. 7:   1    6 0 0.75 0.75
. 8:   1    7 0 0.75 0.75</code></pre>
</div>
<div id="pre-processor-directives" class="section level3" number="11.6.5">
<h3>
<span class="header-section-number">11.6.5</span> Pre-processor directives<a class="anchor" aria-label="anchor" href="#pre-processor-directives"><i class="fas fa-link"></i></a>
</h3>
<p>Pre-processor directives are global substitutions that are made in your
model code at the time the model is compiled. For example</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb472-1"><a href="topics.html#cb472-1" aria-hidden="true" tabindex="-1"></a>$GLOBAL </span>
<span id="cb472-2"><a href="topics.html#cb472-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-3"><a href="topics.html#cb472-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CP (CENT/VC)</span></span></code></pre></div>
<p>When you write this into your model, the pre-processor will find every
instance of <code>CP</code> and <strong>replace</strong> it with <code>(CENT/VC)</code>. This substitution
happens right as the model is compiled; you won’t see this substitution happen
anywhere, but think of it as literal replacement of <code>CP</code> with <code>(CENT/VC)</code>.</p>
<p><strong>Note</strong>:</p>
<ul>
<li>Put all pre-processor directives in <code>$GLOBAL</code>.</li>
<li>It is usually a good idea to enclose the substituted coded in parentheses;
this ensures that, for example, <code>CENT/VC</code> is evaluated as is, regardless of
the surrounding code where it is evaluated.</li>
<li>Under the hood, mrgsolve uses lots of pre-processor directives to define
parameter names, compartment names and other variables; you will see a compiler
error if you try to re-define an existing pre-processor directive. If so,
just choose another name for your directive.</li>
</ul>
</div>
</div>
<div id="resimulate-eta-and-eps" class="section level2" number="11.7">
<h2>
<span class="header-section-number">11.7</span> Resimulate <code>ETA</code> and <code>EPS</code><a class="anchor" aria-label="anchor" href="#resimulate-eta-and-eps"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Call <code>simeps(n)</code> to resimulate <code>ETA</code></strong></p>
<ul>
<li>No <code>$PLUGIN</code> is required</li>
<li>
<code>simeta(n)</code> takes a single argument (<code>n</code>), the ETA number to resimulate</li>
</ul>
<p>For example, we can simulate individual-level covariates
within a certain range:</p>
<div class="sourceCode" id="cb473"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">code</span> <span class="op">&lt;-</span> <span class="st">'
$PARAM TVCL = 1, TVWT = 70

$MAIN 
capture WT = TVWT*exp(EWT);

int i = 0;

while((WT &lt; 60) || (WT &gt; 80)) {
  if(++i &gt; 100) break;
  simeta(1);
  WT = TVWT*exp(EWT);
}

$OMEGA @labels EWT
4

$CAPTURE EWT WT
'</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mcode.html">mcode</a></span><span class="op">(</span><span class="st">"simeta"</span>, <span class="va">code</span><span class="op">)</span>

<span class="va">out</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>nid<span class="op">=</span><span class="fl">100</span>, end<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>

<span class="va">sum</span></code></pre></div>
<pre><code>.        ID              time        EWT                  WT       
.  Min.   :  1.00   Min.   :0   Min.   :-0.152612   Min.   :60.09  
.  1st Qu.: 25.75   1st Qu.:0   1st Qu.:-0.087695   1st Qu.:64.12  
.  Median : 50.50   Median :0   Median :-0.008377   Median :69.42  
.  Mean   : 50.50   Mean   :0   Mean   :-0.014730   Mean   :69.22  
.  3rd Qu.: 75.25   3rd Qu.:0   3rd Qu.: 0.052240   3rd Qu.:73.75  
.  Max.   :100.00   Max.   :0   Max.   : 0.131802   Max.   :79.86</code></pre>
<p><strong>Call <code>simeps(n)</code> to resimulate <code>EPS</code></strong></p>
<ul>
<li>No <code>$PLUGIN</code> is required</li>
<li>
<code>simeps()</code> takes a single argument (<code>n</code>), the EPS number to resimulate</li>
</ul>
<p>For example, we can resimulate until all
concentrations are greater than zero:</p>
<div class="sourceCode" id="cb475"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">code</span> <span class="op">&lt;-</span> <span class="st">'
$PARAM CL = 1, V = 20,

$CMT CENT

$SIGMA 50

$PKMODEL ncmt=1

$TABLE
capture CP = CENT/V + EPS(1);

int i = 0;

while(CP &lt; 0 &amp;&amp; i &lt; 100) {
  simeps(1);
  CP = CENT/V + EPS(1);
  ++i;
}

'</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mcode.html">mcode</a></span><span class="op">(</span><span class="st">"simeps"</span>, <span class="va">code</span><span class="op">)</span>

<span class="va">out</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/ev.html">ev</a></span><span class="op">(</span>amt<span class="op">=</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>end<span class="op">=</span><span class="fl">48</span><span class="op">)</span>
<span class="va">sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>

<span class="va">sum</span></code></pre></div>
<pre><code>.        ID         time            CENT              CP          
.  Min.   :1   Min.   : 0.00   Min.   :  0.00   Min.   : 0.08813  
.  1st Qu.:1   1st Qu.:11.25   1st Qu.: 15.93   1st Qu.: 2.19641  
.  Median :1   Median :23.50   Median : 29.38   Median : 4.24709  
.  Mean   :1   Mean   :23.52   Mean   : 37.47   Mean   : 5.85879  
.  3rd Qu.:1   3rd Qu.:35.75   3rd Qu.: 54.21   3rd Qu.: 8.32122  
.  Max.   :1   Max.   :48.00   Max.   :100.00   Max.   :18.84995</code></pre>
<p><strong>A safety check is recommended</strong>
Note that in both examples, we implement a safety check: an integer counter is
incremented every time we resimulated. The resimulation process stops if we
don’t reach the desired condition within 100 replicates. You might also
consider issuing a message or a flag in the simulated data if you are not able
to reach the desired condition.</p>
</div>
<div id="topics-time-varying" class="section level2" number="11.8">
<h2>
<span class="header-section-number">11.8</span> Time varying covariates<a class="anchor" aria-label="anchor" href="#topics-time-varying"><i class="fas fa-link"></i></a>
</h2>
<p>A note in a previous section showed how to implement time-varying covariates or
other time-varying parameters by including those parameters as column in the
data set.</p>
<p>By default, <code>mrgsolve</code> performs next observation carried backward (<code>nocb</code>) when
processing time-varying covariates. That is, when the system advances from
<code>TIME1</code> to <code>TIME2</code>, and the advance is a function of a covariate found in the
data set, the system advances using the covariate value <code>COV2</code> rather than the
covariate <code>COV1</code>.</p>
<p>The user can change the behavior to last observation carried forward (<code>locf</code>),
so that the system uses the value of <code>COV1</code> to advance from <code>TIME1</code> to <code>TIME2</code>.
To use <code>locf</code> advance, set <code>nocb</code> to <code>FALSE</code> when calling <code>mrgsim</code>. For
example,</p>
<div class="sourceCode" id="cb477"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op"><a href="https://rdrr.io/pkg/mrgsolve/man/zchain.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/mrgsolve/man/mrgsim.html">mrgsim</a></span><span class="op">(</span>nocb <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>There is additional information about the sequence of events that takes place
during system advance in section <a href="section-sequence.html#section-sequence">7</a>.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="mtime.html"><span class="header-section-number">10</span> Modeled events</a></div>
<div class="next"><a href="q-and-a.html"><span class="header-section-number">12</span> Questions and Answers</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#topics"><span class="header-section-number">11</span> Topics</a></li>
<li><a class="nav-link" href="#topic-annotated"><span class="header-section-number">11.1</span> Annotated model specification</a></li>
<li>
<a class="nav-link" href="#topic-init"><span class="header-section-number">11.2</span> Set initial conditions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#summary"><span class="header-section-number">11.2.1</span> Summary</a></li>
<li><a class="nav-link" href="#make-a-model-only-to-examine-init-behavior"><span class="header-section-number">11.2.2</span> Make a model only to examine init behavior</a></li>
<li><a class="nav-link" href="#example-pkpd-model-with-initial-condition"><span class="header-section-number">11.2.3</span> Example PK/PD model with initial condition</a></li>
<li><a class="nav-link" href="#remember-calling-init-will-let-you-check-to-see-what-is-going-on"><span class="header-section-number">11.2.4</span> Remember: calling init will let you check to see what is going on</a></li>
<li><a class="nav-link" href="#set-initial-conditions-via-idata"><span class="header-section-number">11.2.5</span> Set initial conditions via idata</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#topic-parameter-update"><span class="header-section-number">11.3</span> Updating parameters</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#parameter-update-hierarchy"><span class="header-section-number">11.3.1</span> Parameter update hierarchy</a></li>
<li><a class="nav-link" href="#topic-parameter-update-base"><span class="header-section-number">11.3.2</span> Updating the base parameter list</a></li>
</ul>
</li>
<li><a class="nav-link" href="#topic-tgrid"><span class="header-section-number">11.4</span> Time grid objects</a></li>
<li><a class="nav-link" href="#topic-designs"><span class="header-section-number">11.5</span> Individualized sampling designs</a></li>
<li>
<a class="nav-link" href="#some-helpful-c"><span class="header-section-number">11.6</span> Some helpful C++</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#semi-colons"><span class="header-section-number">11.6.1</span> Semi-colons</a></li>
<li><a class="nav-link" href="#if-else"><span class="header-section-number">11.6.2</span> if-else</a></li>
<li><a class="nav-link" href="#functions-1"><span class="header-section-number">11.6.3</span> Functions</a></li>
<li><a class="nav-link" href="#integer-division"><span class="header-section-number">11.6.4</span> Integer division</a></li>
<li><a class="nav-link" href="#pre-processor-directives"><span class="header-section-number">11.6.5</span> Pre-processor directives</a></li>
</ul>
</li>
<li><a class="nav-link" href="#resimulate-eta-and-eps"><span class="header-section-number">11.7</span> Resimulate ETA and EPS</a></li>
<li><a class="nav-link" href="#topics-time-varying"><span class="header-section-number">11.8</span> Time varying covariates</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>mrgsolve User Guide</strong>" was written by <font color="DarkGreen">Metrum Research Group</font>. It was last built on 2022-03-24.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
